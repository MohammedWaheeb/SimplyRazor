@namespace SW.SimplyRazor
@implements IDisposable
@inject IJSRuntime JSRuntime
@inject IServiceProvider serviceProvider

<select id="@Id" @ref="inputRef" @attributes="UnmatchedAttributes">
    @*<option value="0" selected disabled>Please enter your address.</option>*@
</select>

@code {

    [Parameter]
    public string Id { get; set; }

    [Parameter]
    public string Lookup { get; set; }

    [Parameter]
    public string Placeholder { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public object Value { get; set; }

    [Parameter]
    public EventCallback<object> ValueChanged { get; set; }

    [Parameter]
    public int TypeAhead { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object> UnmatchedAttributes { get; set; }

    ElementReference inputRef;
    bool rendered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (Id == null) Id = $"dt_{Guid.NewGuid().ToString("N")}";

            await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.init",
                inputRef,
                DotNetObjectReference.Create(this),
                Id,
                TypeAhead == 0 ? 1 : TypeAhead,
                Placeholder);

            if (TypeAhead == 0)
            {
                await PopulateChoices($"{Lookup}?lookup=true");

            }
            else if (Value != default)
            {
                var apiClient = serviceProvider.GetApiClient();
                var result = await apiClient.Lookup($"{Lookup}/{Value}?lookup=true");
                if (result.Success)
                    await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.setChoices", Id, new[] { new { Key = Value, Value = result.Response, selected = true } }, "key", "value");
            }

            //StateHasChanged();


            if (Disabled) await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.disable", Id);
            rendered = true;
        }
    }

    async protected override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (rendered && TypeAhead > 0)
        {
            if (Value != null)
            {
                await PopulateChoices($"{Lookup}?lookup=true&search={Value}");
                await InvokeAsync(() => StateHasChanged());
            }

            //await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.setChoice", Id, Value);
        }
    }

    Debouncer StepperDeboucer = new Debouncer(); // one second

    [JSInvokable]
    async public Task OnSearch(string value, int resultCount)
    {
        if (TypeAhead > 0)

            await StepperDeboucer.Debouce(async () =>
            {
                await PopulateChoices($"{Lookup}?lookup=true&search={value}");

                await InvokeAsync(() => StateHasChanged());
            });
    }

    [JSInvokable]
    async public Task OnChange(string value)
    {
        await ValueChanged.InvokeAsync(value);
    }

    async Task PopulateChoices(string url)
    {
        var apiClient = serviceProvider.GetApiClient();
        var apiResult = await apiClient.Search(url);
        if (apiResult.Success)
        {
            await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.setChoices", Id, apiResult.Response.ToArray(), "Key", "Value");
            if (Value != default)

                await JSRuntime.InvokeVoidAsync("simplyChoicesInterop.setChoice", Id, Value);
        }
    }

    void IDisposable.Dispose()
    {
        JSRuntime.InvokeVoidAsync("simplyChoicesInterop.destroy", Id);
    }
}
